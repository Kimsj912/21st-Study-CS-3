# 6.3 프락시는 어디에 있는가?

이제 프락시가 어디에 있고 언제 네트워크 아키텍처상에 배치가되는지 다뤄본다.

- 어떻게 프락시가 네트워크상에 배치되는가
- 어떻게 프락시의 연쇄가 계층을 이루는가
- 어떻게 트래픽이 올바르게 프락시를 찾아가는가

<br />

## 6.3.1 프락시 서버 배치

어떻게 사용할지에 따라 프락시는 어디에든 배치할 수 있다. 그리고 프락시 서버가 배치될 수 있는 몇 가지 방법 중에 4가지를 소개한다.

#### 출구(Egress) 프락시

로컬 네트워크와 더 큰 인터넷 사이에 오가는 트래픽을 제어하기 위해 프락시를 로컬 네트워크의 출구에 배치할 수 있다. 이는 **회사 밖의 악의적인 해커들을 막는 방화벽을 제공**하기 위해, 혹은 인터넷 요금을 절약하고 트래픽의 성능을 개선하기 위해 회사에서 프락시로 사용할 수 있다. 그리고 부적절한 콘텐츠를 브라우징하는 것을 막기 위해 **필터링 출구 프락시**를 사용할 수 있다.

프락시 자체가 특정 웹 앱에만 적용할 수 있고, 이를 통해 트래픽을 제어할 수 있다. 하지만 암호화는 불가능하기 때문에, 보안 측면에서는 완벽하다고 볼 수 없다. 그래서 정말 중요한 문서 관리에는 사용할 수 없고, 회사, 기관 또는 학교에서 트래픽 제어 용도로 사용하기에 적합하다고 생각한다.

<br />

#### 접근(입구) 프락시

고객으로부터의 모든 요청을 **종합적으로 처리하기 위해** 프락시는 [ISP](https://namu.wiki/w/ISP) 접근 시점에 위치하기도 한다. ISP는 사용자들의 다운로드 속도를 개선하고 인터넷 대역폭 비용을 줄이기 위해 캐시 프락시를 사용해 많이 찾는 문서들의 사본을 저장한다.

<br />

#### 대리 프락시 (리버스 프락시)

대리 프락시는 **네트워크의 가장 끝에 있는 웹 서버들의 바로 앞에 위치**하여 웹 서버로 향하는 모든 요청을 처리하고 **필요할 때만 웹 서버에게 자원을 요청할 수 있다.** 또한 보안 기능이나 느린 웹 서버의 앞에 배치해서 웹 성능 개선도 할 수 있다. 대리 프락시는 일반적으로 **웹 서버의 이름과 IP 주소로 스스로를 가정하기 때문에, 모든 요청은 서버가 아닌 이 프락시로 가게 된다.**


<br />

#### 네트워크 교환 프락시

**캐시를 이용해 인터넷 교차로의 혼잡을 완화하고 트래픽 흐름을 감시**하기 위해 네트워크 사이의 인터넷 피어링 교환 시점에 배치한다.


(그림 첨부 예정)

<br />
<br />

## 6.3.2 프락시 계층

아래 그림과 같이, 프락시들은 **프락시 계층이라고 불리는 연쇄를 구성할 수 있다.** 프락시 계층에서 메시지가 원 서버에 도착할 때까지 프락시와 프락시을 거쳐 이동한다.

**프락시 계층에서 프락시 서버들은 부모와 자식의 관계를 갖는다.** 서버에 가까운 쪽(인바운드 프락시)을 부모라고 부르며 클라이언트 쪽에 가까운 쪽(아웃바운드 프락시)을 자식이라고 부른다.

(그림 첨부 예정)

<br />

#### 프락시 계층 콘텐츠 라우팅

프락시 계층은 정적이다. 하지만 **여러 가지 판단 근거에 의해 메시지를 다양하고 유동적인 프락시 서버와 원 서버들의 집합에게 보낼 수 있다.** 접근 프락시는 상황에 맞게 부모 프락시나 원 서버에게 라우팅한다.

- 요청된 객체가 콘텐츠 분산을 위해 돈을 지불한 웹 서버에 속한 경우, 프락시는 **요청을 가까운 캐시 서버에게 보내 캐시된 객체를 반환**하거나 그럴 수 없을 때는 **서버에서 가져오게 할 수 있다.**
- 요청이 특정 종류의 **이미지에 대한 것인 경우** 접근 프락시는 **이미지에 대해 특화된 압축 프락시에게 보내어 그 프락시가 이미지를 가져와 압축하게 하여** 느린 모뎀으로 접속했더라도 빠르게 클라이언트가 다운로드할 수 있게 한다.

<br />

#### 부하 균형

자식 프락시는 부하를 분산하기 위해 **현재 부모들의 작업량 수준에 근거하여** 부모 프락시를 고른다.

<br />

#### 지리적 인접성에 근거한 라우팅

자식 프락시는 **원 서버의 지역을 담당하는 부모를 선택할 수도 있다.**

<br />

#### 프로토콜/타입 라우팅

어떤 자식 프락시는 **URI에 근거하여 다른 부모나 원 서버로 라우팅**할 수 있다. 특정 종류의 URI를 갖고 있는 경우, 특별한 프락시 서버로 보내져 특별한 프로토콜로 처리될 수도 있다.

(그림 첨부 예정)

<br />

#### 유료 서비스 가입자를 위한 라우팅

웹 서비스 운영자가 빠른 서비스를 위해 추가금을 지불했다면, 그들의 URI는 **대형 캐시나 성능 개선을 위한 압축 엔진으로 라우팅될 수 있다.**

<br />
<br />

## 6.3.3 어떻게 프락시가 트래픽을 처리하는가

클라이언트는 보통 웹 서버와 직접 대화를 한다. 그렇기 때문에 먼저 **어떻게 HTTP 트래픽이 프락시로 향하는 길을 찾아내는지 설명할 필요가 있다.**

<br />

#### 클라이언트를 수정한다

많은 웹 클라이언트(크롬, 엣지 등)들은 수동 혹은 자동 프락시 설정을 지원한다. 클라이언트가 프락시를 사용하도록 설정했다면, 클라이언트는 **HTTP 요청을 의도적으로 원 서버가 아닌 프락시로 보낸다.**

(그림 첨부 예정)

<br />

#### 네트워크를 수정한다

클라이언트는 알지도 못하고 간섭도 할 수 없는 상태에서, 네트워크 인프라를 가로채서 웹 트래픽을 프락시로 가도록 조정하는 몇 가지 방법이 있다. **HTTP 트래픽을 지켜보고 가로채어 클라이언트 모르게 트래픽을 프락시로 보내는** 스위치 장치와 라우팅 장치를 필요로 한다. 이것을 **인터셉트 프락시**라고 부른다.

<br />

#### DNS 이름공간을 수정한다

대리 프락시는 웹 서버의 이름과 IP 주소를 자신이 직접 사용한다. 그래서 모든 요청은 서버 대신 대리 프락시로 간다. 이는 **DNS 이름 테이블을 수동으로 편집**하거나, 프락시나 서버를 계산해주는 **특별한 동적 DNS 서버를 이용**해서 조정될 수 있다. 실제 서버의 IP 주소와 이름은 변경되고 대리 프락시에게는 이전의 주소와 이름이 주어진다.


<br />

#### 웹 서버를 수정한다

웹 서버는 HTTP 리다이렉션 명령(응답 코드 305)을 클라이언트에게 돌려줌으로써 클라이언트의 요청을 프락시로 리다이렉트 하도록 설정할 수 있다. **리다이렉트를 받는 즉시 클라이언트는 프락시와의 트랜잭션을 시작한다.**